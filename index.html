<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ninja Adventure - Japon M√©di√©val</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background: #1a1a1a; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        canvas { 
            display: block; 
            background: linear-gradient(to bottom, #87CEEB, #E0F6FF);
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .unselectable { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        
        #shuriken-transition {
            pointer-events: none;
            display: none;
            z-index: 100;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes shuriken-spin-grow {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) rotate(720deg) scale(25); opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(1440deg) scale(35); opacity: 0; }
        }

        .shuriken-animate {
            display: block !important;
            animation: shuriken-spin-grow 1.5s ease-in-out forwards;
        }

        .num-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1.25rem;
            font-weight: bold;
            padding: 12px;
            transition: all 0.1s;
        }
        .num-btn:active {
            background: #e5e7eb;
            transform: scale(0.95);
        }

        /* Cin√©matique de Fin */
        #final-cinematic { transition: opacity 1s ease-in-out; }
        .bounce { animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        
        .sakura {
            position: absolute;
            background: #ffb7c5;
            border-radius: 10px 0 10px 0;
            pointer-events: none;
            animation: fall linear forwards;
            z-index: 60;
        }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

        /* Correction des contr√¥les tactiles pour tablettes */
        #mobile-controls {
            display: none; /* Masqu√© par d√©faut, affich√© par JS si tactile */
        }
    </style>
</head>
<body class="unselectable">

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="shuriken-transition">
            <svg width="100" height="100" viewBox="0 0 100 100" fill="currentColor" class="text-gray-800">
                <path d="M50 0 L60 40 L100 50 L60 60 L50 100 L40 60 L0 50 L40 40 Z" />
                <circle cx="50" cy="50" r="8" fill="white" />
            </svg>
        </div>

        <div id="start-screen" class="absolute inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center text-white z-50 p-6">
            <h1 class="text-5xl md:text-8xl font-bold mb-4 text-red-600 tracking-tighter uppercase italic text-center drop-shadow-lg">Ninja Adventure</h1>
            <p class="mb-10 text-xl md:text-2xl text-gray-300">Le Ma√Ætre du Shinobi</p>
            <button id="btn-play" class="px-12 py-5 bg-red-600 hover:bg-red-700 text-white font-bold rounded-full text-3xl transition-transform transform hover:scale-110 shadow-2xl">JOUER</button>
        </div>

        <div id="ui-overlay" class="absolute top-4 left-4 right-4 flex justify-between items-start pointer-events-none hidden">
            <div class="flex flex-col gap-2">
                <div id="health-bar" class="text-3xl md:text-4xl filter drop-shadow">üèÆüèÆüèÆ</div>
                <div class="bg-black bg-opacity-60 px-4 py-2 rounded-lg text-white font-bold text-xs md:text-base border border-gray-700">
                    Score: <span id="score-val" class="text-yellow-400">0</span> / 100
                </div>
                <div class="bg-black bg-opacity-60 px-4 py-2 rounded-lg text-white font-bold text-xs md:text-base border border-gray-700">
                    Niveau: <span id="level-val" class="text-red-400">1</span> / 5
                </div>
            </div>
        </div>

        <!-- Modale Math√©matique -->
        <div id="modal-math" class="absolute inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-40 p-4">
            <div class="bg-white p-6 rounded-2xl text-center max-w-sm w-full shadow-2xl border-4 border-yellow-600">
                <h2 class="text-lg font-bold mb-3 uppercase text-gray-500 tracking-widest">√ânigme du Scribe</h2>
                <div id="math-question" class="text-3xl font-mono mb-4 bg-yellow-50 py-3 rounded-xl border-2 border-yellow-200 text-gray-800"></div>
                <div id="math-display" class="text-4xl font-bold mb-6 h-12 flex items-center justify-center text-red-600 border-b-4 border-gray-100"></div>
                <div class="grid grid-cols-3 gap-2">
                    <button class="num-btn" data-val="1">1</button>
                    <button class="num-btn" data-val="2">2</button>
                    <button class="num-btn" data-val="3">3</button>
                    <button class="num-btn" data-val="4">4</button>
                    <button class="num-btn" data-val="5">5</button>
                    <button class="num-btn" data-val="6">6</button>
                    <button class="num-btn" data-val="7">7</button>
                    <button class="num-btn" data-val="8">8</button>
                    <button class="num-btn" data-val="9">9</button>
                    <button class="num-btn bg-red-100 text-red-700" id="btn-math-clear">C</button>
                    <button class="num-btn" data-val="0">0</button>
                    <button id="btn-math-val" class="num-btn bg-green-600 text-white">OK</button>
                </div>
            </div>
        </div>

        <!-- Modale Pendu -->
        <div id="modal-word" class="absolute inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-40 p-4">
            <div class="bg-white p-8 rounded-2xl text-center max-w-lg w-full shadow-2xl border-4 border-gray-800">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">D√©fi du Silence</h2>
                <div id="hangman-word" class="text-3xl md:text-4xl tracking-[0.4em] font-mono mb-6 text-black font-black"></div>
                <div id="hangman-tries" class="text-red-600 font-bold mb-6 text-lg">Erreurs: 0 / 10</div>
                <div id="keyboard" class="grid grid-cols-7 md:grid-cols-9 gap-1.5 mb-6"></div>
                <p id="word-reveal" class="text-xl text-red-700 font-black hidden bg-red-50 p-2 rounded"></p>
            </div>
        </div>

        <!-- CIN√âMATIQUE DE FIN -->
        <div id="final-cinematic" class="absolute inset-0 bg-gradient-to-b from-blue-300 to-green-100 hidden z-50 overflow-hidden">
             <div class="absolute bottom-20 w-full flex justify-around items-end">
                <div class="text-7xl md:text-9xl opacity-80">üè†</div>
                <div class="text-7xl md:text-9xl opacity-80">‚õ©Ô∏è</div>
                <div class="text-7xl md:text-9xl opacity-80">üè†</div>
             </div>
             <div class="absolute bottom-0 w-full h-20 bg-green-800 border-t-4 border-green-900"></div>
             <div id="cine-actors-container" class="absolute inset-0">
                <div id="cine-friend-cage" class="absolute bottom-20 right-1/4 flex flex-col items-center">
                    <div id="cine-cage" class="text-6xl md:text-7xl z-10">‚õìÔ∏è</div>
                    <div id="cine-friend" class="text-5xl md:text-6xl absolute top-2 transition-all duration-500">ü•∑</div>
                    <div class="text-xs font-bold text-green-800 bg-white px-1 rounded absolute -top-4">AMI</div>
                </div>
                <div id="cine-royalty" class="absolute bottom-20 right-1/2 translate-x-1/2 flex gap-4 md:gap-8 opacity-0 transition-opacity duration-1000">
                    <div class="text-5xl md:text-7xl flex flex-col items-center"><span class="text-xs bg-yellow-400 px-2 rounded mb-1">ROI</span>üëë</div>
                    <div class="text-5xl md:text-7xl flex flex-col items-center"><span class="text-xs bg-pink-400 px-2 rounded mb-1 text-white">REINE</span>üë∏</div>
                </div>
                <div id="cine-villagers" class="absolute bottom-20 w-full flex justify-between px-10 opacity-0 transition-opacity duration-1000">
                    <div class="flex gap-2 md:gap-4"><div class="text-4xl md:text-5xl villager">üë®‚Äçüåæ</div><div class="text-4xl md:text-5xl villager">üë©‚Äçüåæ</div></div>
                    <div class="flex gap-2 md:gap-4"><div class="text-4xl md:text-5xl villager">üë®‚Äçüé®</div><div class="text-4xl md:text-5xl villager">üë©‚Äçüç≥</div></div>
                </div>
                <div id="cine-hero" class="absolute bottom-20 -left-20 text-5xl md:text-6xl transition-all duration-1000">ü•∑</div>
             </div>
             <div id="cine-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-40 opacity-0 transition-opacity duration-2000 pointer-events-none">
                <div class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl text-center scale-90 transition-transform duration-1000" id="final-card">
                    <h2 class="text-3xl md:text-5xl font-black text-red-700 mb-4">VICTOIRE TOTALE</h2>
                    <p class="text-lg md:text-xl text-gray-700 mb-6 italic">Le village est en paix !</p>
                    <div id="final-gift" class="text-6xl md:text-8xl mb-6">üéÅ</div>
                    <button onclick="location.reload()" class="px-8 py-3 bg-red-600 text-white rounded-full font-bold text-xl md:text-2xl hover:bg-red-700 pointer-events-auto shadow-lg">REJOUER</button>
                </div>
             </div>
        </div>

        <!-- CONTR√îLES TACTILES (Adapt√©s Tablettes & Mobiles) -->
        <div id="mobile-controls" class="absolute bottom-6 left-6 right-6 flex justify-between pointer-events-none unselectable">
            <div class="flex gap-3 md:gap-6 pointer-events-auto">
                <button id="btn-left" class="w-16 h-16 md:w-24 md:h-24 bg-white bg-opacity-20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl md:text-5xl border-2 border-white border-opacity-30">‚¨ÖÔ∏è</button>
                <button id="btn-right" class="w-16 h-16 md:w-24 md:h-24 bg-white bg-opacity-20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl md:text-5xl border-2 border-white border-opacity-30">‚û°Ô∏è</button>
            </div>
            <div class="flex gap-3 md:gap-6 pointer-events-auto">
                <button id="btn-jump" class="w-16 h-16 md:w-24 md:h-24 bg-blue-600 bg-opacity-30 backdrop-blur-md rounded-full flex items-center justify-center text-3xl md:text-5xl border-2 border-blue-400">‚¨ÜÔ∏è</button>
                <button id="btn-shoot" class="w-16 h-16 md:w-24 md:h-24 bg-red-600 bg-opacity-30 backdrop-blur-md rounded-full flex items-center justify-center text-3xl md:text-5xl border-2 border-red-400">‚ú¥Ô∏è</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // D√©tection du tactile (Tablettes + Mobiles)
        const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
        if (isTouchDevice) {
            document.getElementById('mobile-controls').style.display = 'flex';
        }

        const VIRTUAL_WIDTH = 800;
        const VIRTUAL_HEIGHT = 450;

        function resize() {
            const container = document.getElementById('game-container');
            const ratio = VIRTUAL_WIDTH / VIRTUAL_HEIGHT;
            let w = container.clientWidth;
            let h = container.clientHeight;
            if (w / h > ratio) w = h * ratio; else h = w / ratio;
            canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
            canvas.width = VIRTUAL_WIDTH; canvas.height = VIRTUAL_HEIGHT;
        }
        window.addEventListener('resize', resize);
        resize();

        function playSound(freq, type, duration, vol = 0.1) {
            try {
                if (audioCtx.state === 'suspended') return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + duration);
            } catch(e) {}
        }

        let endMusicInterval = null;
        function playEndMusic() {
            const melody = [440, 493, 523, 587, 659, 783, 880];
            let step = 0;
            if(endMusicInterval) return;
            endMusicInterval = setInterval(() => {
                const note = melody[Math.floor(Math.random() * melody.length)];
                playSound(note, 'triangle', 0.8, 0.15);
                if(step % 4 === 0) playSound(110, 'sine', 1.0, 0.1);
                step++;
            }, 400);
        }

        const sounds = {
            jump: () => playSound(400, 'square', 0.2),
            star: () => playSound(880, 'sine', 0.15, 0.2),
            hit: () => playSound(150, 'sawtooth', 0.3),
            shoot: () => playSound(1200, 'sine', 0.1, 0.05),
            puzzleWin: () => { playSound(523, 'sine', 0.1, 0.2); setTimeout(() => playSound(659, 'sine', 0.1, 0.2), 100); setTimeout(() => playSound(783, 'sine', 0.3, 0.2), 200); },
            puzzleFail: () => { playSound(200, 'sawtooth', 0.2, 0.2); setTimeout(() => playSound(150, 'sawtooth', 0.4, 0.2), 150); },
            bossFree: () => {
                const now = audioCtx.currentTime;
                [80, 120, 64].forEach((f) => {
                    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(f, now);
                    osc.frequency.exponentialRampToValueAtTime(f / 2, now + 1.2);
                    gain.gain.setValueAtTime(0.4, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(); osc.stop(now + 1.2);
                });
            },
            claps: () => {
                setInterval(() => { if(state.win) playSound(Math.random() * 200 + 400, 'triangle', 0.05, 0.05); }, 200);
            }
        };

        const state = {
            playing: false, level: 1, score: 0, lives: 3, cameraX: 0,
            keys: {}, stars: [], puzzles: [], shurikens: [], fireballs: [], platforms: [],
            boss: null, cage: null, shurikenCooldown: 0, animationFrame: 0, win: false, transitioning: false,
            mathInput: "", wordBank: ["NINJA", "SAMURAI", "KATANA", "SHURIKEN", "DRAGON", "SUSHI", "DOJO", "SENSEI", "KIMONO", "SABRE", "OMBRE", "SILENCE", "FORCE", "COURAGE", "VICTOIRE", "ESPRIT", "MAITRE", "COMBAT", "VOIE", "PANDA", "TEMPLE", "RITUEL"], usedWords: []
        };

        const config = { gravity: 0.6, jumpForce: -14, speed: 5, levelWidth: 3000, dragonMaxHP: 3 };

        class Ninja {
            constructor() { this.x = 100; this.y = 300; this.w = 40; this.h = 60; this.vx = 0; this.vy = 0; this.grounded = false; this.frame = 0; this.facing = 1; this.invul = 0; }
            draw() {
                ctx.save(); ctx.translate(this.x - state.cameraX + this.w / 2, this.y + this.h / 2);
                if (this.facing === -1) ctx.scale(-1, 1);
                if (this.invul % 10 > 5) ctx.globalAlpha = 0.3;
                let legMove = Math.sin(this.frame * 0.2) * 12; if (Math.abs(this.vx) < 0.1) legMove = 0;
                ctx.strokeStyle = "#111"; ctx.lineWidth = 7; ctx.lineCap = "round";
                ctx.beginPath(); ctx.moveTo(5, 10); ctx.lineTo(5 - legMove, 28); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-5, 10); ctx.lineTo(-5 + legMove, 28); ctx.stroke();
                ctx.fillStyle = "#1a1a1a"; ctx.beginPath(); ctx.roundRect(-16, -26, 32, 42, 4); ctx.fill();
                ctx.fillStyle = "#8b0000"; ctx.fillRect(-17, -2, 34, 6);
                ctx.fillStyle = "#1a1a1a"; ctx.beginPath(); ctx.roundRect(-12, -42, 24, 20, 5); ctx.fill();
                ctx.fillStyle = "#ffdbac"; ctx.fillRect(-10, -36, 20, 6); ctx.fillStyle = "#000"; ctx.fillRect(-6, -34, 4, 2); ctx.fillRect(2, -34, 4, 2);
                ctx.fillStyle = "#b22222"; ctx.beginPath(); ctx.moveTo(-10, -38);
                let wave = Math.sin(state.animationFrame * 0.15) * 8; ctx.quadraticCurveTo(-25, -45 + wave, -45, -35 + wave); ctx.lineTo(-43, -30 + wave); ctx.quadraticCurveTo(-25, -40 + wave, -10, -34); ctx.fill();
                let armMove = Math.cos(this.frame * 0.2) * 10; if (Math.abs(this.vx) < 0.1) armMove = 0;
                ctx.strokeStyle = "#111"; ctx.lineWidth = 6; ctx.beginPath(); ctx.moveTo(-10, -15); ctx.lineTo(-18 - armMove, 0); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(10, -15); ctx.lineTo(18 + armMove, 0); ctx.stroke();
                ctx.restore();
            }
            update() {
                if (state.transitioning) return;
                if (state.keys['ArrowLeft'] || state.keys['left']) { this.vx = -config.speed; this.facing = -1; this.frame++; }
                else if (state.keys['ArrowRight'] || state.keys['right']) { this.vx = config.speed; this.facing = 1; this.frame++; }
                else { this.vx = 0; }
                if ((state.keys['ArrowUp'] || state.keys['jump']) && this.grounded) { this.vy = config.jumpForce; this.grounded = false; sounds.jump(); }
                if ((state.keys[' '] || state.keys['shoot']) && state.shurikenCooldown <= 0) {
                    state.shurikens.push({ x: this.x + (this.facing === 1 ? 40 : -10), y: this.y + 20, vx: this.facing * 10, angle: 0 });
                    state.shurikenCooldown = 20; sounds.shoot();
                }
                this.vy += config.gravity; this.x += this.vx; this.y += this.vy;
                if (this.x < 0) this.x = 0; if (this.x > config.levelWidth - 100) this.x = config.levelWidth - 100;
                this.grounded = false;
                state.platforms.forEach(p => { if (this.x + this.w > p.x && this.x < p.x + p.w && this.y + this.h >= p.y && this.y + this.h <= p.y + 20 && this.vy >= 0) { this.y = p.y - this.h; this.vy = 0; this.grounded = true; } });
                if (!state.boss.freed) { const c = state.cage; if (this.x + this.w > c.x && this.x < c.x + c.w && this.y + this.h >= c.y && this.y + this.h <= c.y + 20 && this.vy >= 0) { this.y = c.y - this.h; this.vy = 0; this.grounded = true; } }
                if (this.y > 350) { this.y = 350; this.vy = 0; this.grounded = true; }
                if (this.invul > 0) this.invul--;
            }
        }

        class Boss {
            constructor() { this.x = 2585; this.y = 325; this.w = 80; this.h = 80; this.hp = config.dragonMaxHP; this.freed = false; this.dir = 1; this.attackTimer = 0; }
            draw() {
                ctx.save(); ctx.translate(this.x - state.cameraX + 40, this.y + 40); if (this.dir === 1) ctx.scale(-1, 1);
                ctx.font = "80px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("üêâ", 0, 0); ctx.restore();
                if (this.freed) { ctx.fillStyle = "#eee"; ctx.fillRect(this.x - state.cameraX, this.y - 20, 80, 8); ctx.fillStyle = "red"; ctx.fillRect(this.x - state.cameraX, this.y - 20, 80 * (this.hp / config.dragonMaxHP), 8); }
            }
            update() {
                if (state.transitioning) return;
                if (!this.freed) { if (state.score >= 100) { this.freed = true; sounds.bossFree(); } return; }
                this.x += this.dir * (1.5 + state.level * 0.4); if (this.x < 2400 || this.x > 2850) this.dir *= -1;
                this.attackTimer++; let fireRate = 180 - (state.level * 25);
                if (this.attackTimer > fireRate) {
                    let fireSpeed = 3 + (state.level * 0.5);
                    state.fireballs.push({ x: this.x + 40, y: this.y + 40, vx: (state.ninja.x < this.x ? -fireSpeed : fireSpeed), vy: 0 });
                    this.attackTimer = 0;
                }
            }
        }

        function initLevel() {
            state.score = 0; state.stars = []; state.puzzles = []; state.platforms = []; state.shurikens = []; state.fireballs = [];
            state.ninja = new Ninja(); state.boss = new Boss(); state.cameraX = 0; state.shurikenCooldown = 0;
            for (let i = 0; i < 15; i++) state.stars.push({ x: 300 + i * 160, y: 150 + Math.random() * 150, collected: false });
            for (let i = 0; i < 4; i++) state.puzzles.push({ x: 500 + i * 500, y: 340, type: i % 2 === 0 ? 'math' : 'word', solved: false });
            state.platforms.push({ x: 0, y: 410, w: config.levelWidth, h: 40 }); 
            for (let i = 0; i < 10; i++) state.platforms.push({ x: 300 + i * 220, y: 300 - (i % 3) * 40, w: 120, h: 20 });
            state.cage = { x: 2550, y: 310, w: 150, h: 100 };
            document.getElementById('level-val').innerText = state.level;
            updateUI();
        }

        function updateUI() { document.getElementById('score-val').innerText = state.score; document.getElementById('health-bar').innerText = "üèÆ".repeat(Math.max(0, state.lives)); }

        function checkCollisions() {
            if (state.transitioning) return;
            const n = state.ninja;
            state.stars.forEach(s => { if (!s.collected && n.x < s.x + 30 && n.x + n.w > s.x && n.y < s.y + 30 && n.y + n.h > s.y) { s.collected = true; state.score += 5; sounds.star(); updateUI(); } });
            state.puzzles.forEach(p => { if (!p.solved && n.x < p.x + 40 && n.x + n.w > p.x && n.y < p.y + 40 && n.y + n.h > p.y) openPuzzle(p); });
            if (state.boss.freed) {
                if (n.x < state.boss.x + 80 && n.x + n.w > state.boss.x && n.y < state.boss.y + 80 && n.y + n.h > state.boss.y) {
                    if (n.vy > 0 && (n.y + n.h) < (state.boss.y + 50)) { state.boss.hp--; n.vy = -12; sounds.hit(); } else if (n.invul === 0) takeDamage();
                }
                state.fireballs.forEach((f, i) => { if (n.invul === 0 && n.x < f.x + 20 && n.x + n.w > f.x && n.y < f.y + 20 && n.y + n.h > f.y) { takeDamage(); state.fireballs.splice(i, 1); } });
                state.shurikens.forEach((s, si) => { if (s.x < state.boss.x + 80 && s.x > state.boss.x && s.y < state.boss.y + 80 && s.y > state.boss.y) { state.boss.hp--; state.shurikens.splice(si, 1); sounds.hit(); } });
                if (state.boss.hp <= 0) nextLevel();
            }
        }

        function takeDamage() { state.lives--; state.ninja.invul = 100; sounds.hit(); updateUI(); if (state.lives <= 0) { state.lives = 3; initLevel(); } }

        function nextLevel() {
            if (state.transitioning) return;
            state.transitioning = true;
            document.getElementById('shuriken-transition').classList.add('shuriken-animate');
            setTimeout(() => {
                if (state.level < 5) {
                    state.level++; initLevel(); state.transitioning = false;
                } else {
                    state.win = true; state.playing = false;
                    document.getElementById('final-cinematic').classList.remove('hidden');
                    startFinalCinematic();
                }
            }, 750);
            setTimeout(() => document.getElementById('shuriken-transition').classList.remove('shuriken-animate'), 1500);
        }

        function spawnSakura() {
            const petal = document.createElement('div');
            petal.className = 'sakura';
            petal.style.left = Math.random() * 100 + 'vw';
            petal.style.width = petal.style.height = (Math.random() * 10 + 5) + 'px';
            petal.style.animationDuration = (Math.random() * 3 + 2) + 's';
            petal.style.opacity = Math.random();
            document.getElementById('final-cinematic').appendChild(petal);
            setTimeout(() => petal.remove(), 5000);
        }

        function startFinalCinematic() {
            playEndMusic();
            const hero = document.getElementById('cine-hero');
            const cage = document.getElementById('cine-cage');
            const friend = document.getElementById('cine-friend');
            const royalty = document.getElementById('cine-royalty');
            const villagers = document.getElementById('cine-villagers');
            const overlay = document.getElementById('cine-overlay');

            setTimeout(() => { hero.style.left = '65%'; hero.classList.add('bounce'); }, 100);
            setTimeout(() => {
                hero.classList.remove('bounce'); cage.innerText = 'üí•';
                setTimeout(() => { 
                    cage.style.opacity = '0'; 
                    friend.style.transform = 'translateX(-60px)';
                    friend.innerText = 'ü•∑‚ú®'; 
                    friend.style.borderBottom = "3px solid #22c55e"; 
                    playSound(600, 'sine', 0.5);
                }, 500);
            }, 1500);
            setTimeout(() => { royalty.style.opacity = '1'; villagers.style.opacity = '1'; document.querySelectorAll('.villager').forEach(v => v.classList.add('bounce')); sounds.claps(); }, 3000);
            setTimeout(() => { 
                hero.style.transform = 'scale(1.2)'; 
                friend.style.transform = 'scale(1.2) translateX(-60px)'; 
                overlay.style.opacity = '1'; 
                document.getElementById('final-card').style.transform = 'scale(1)'; 
                setInterval(spawnSakura, 100); 
            }, 6000);
        }

        window.addDigit = (n) => { if (state.mathInput.length < 4) { state.mathInput += n; document.getElementById('math-display').innerText = state.mathInput; playSound(800, 'sine', 0.03, 0.03); } };
        window.clearDigits = () => { state.mathInput = ""; document.getElementById('math-display').innerText = ""; };
        window.validateMath = () => { const val = parseInt(state.mathInput); const success = (val === state.mathAns); if (success) sounds.puzzleWin(); else sounds.puzzleFail(); closePuzzle(success); };

        function openPuzzle(p) { 
            state.currentPuzzle = p; state.playing = false; 
            if (p.type === 'math') { 
                const max = 10 * state.level; const a = Math.floor(Math.random() * max) + 5; const b = Math.floor(Math.random() * 20); 
                state.mathAns = a + b; document.getElementById('math-question').innerText = `${a} + ${b} = ?`; 
                document.getElementById('modal-math').classList.remove('hidden'); 
            } else { startHangman(); } 
        }

        function startHangman() {
            let available = state.wordBank.filter(w => !state.usedWords.includes(w)); if (available.length === 0) { state.usedWords = []; available = state.wordBank; }
            state.word = available[Math.floor(Math.random() * available.length)]; state.guessed = []; state.tries = 10; updateHangmanUI(); document.getElementById('modal-word').classList.remove('hidden');
            const kb = document.getElementById('keyboard'); kb.innerHTML = ''; "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').forEach(l => {
                const b = document.createElement('button'); b.className = "bg-gray-100 p-2 text-sm rounded-lg font-bold border-2 active:bg-gray-300"; b.innerText = l;
                b.onclick = () => { if (b.disabled) return; b.disabled = true; b.className = "bg-gray-400 p-2 opacity-50"; if (state.word.includes(l)) { state.guessed.push(l); playSound(900, 'sine', 0.05); } else { state.tries--; playSound(100, 'sawtooth', 0.1); } updateHangmanUI();
                    const win = state.word.split('').every(char => state.guessed.includes(char)); if (win || state.tries <= 0) { if (win) sounds.puzzleWin(); else sounds.puzzleFail(); setTimeout(() => closePuzzle(win), 1000); } }; kb.appendChild(b);
            });
        }
        function updateHangmanUI() { document.getElementById('hangman-word').innerText = state.word.split('').map(l => state.guessed.includes(l) ? l : '_').join(''); document.getElementById('hangman-tries').innerText = `Erreurs: ${10 - state.tries} / 10`; }
        function closePuzzle(success) { document.getElementById('modal-math').classList.add('hidden'); document.getElementById('modal-word').classList.add('hidden'); if (success) { state.score += 20; state.currentPuzzle.solved = true; } else { state.ninja.x -= 120; } state.playing = true; updateUI(); gameLoop(); }

        function drawBackground() {
            ctx.fillStyle = "#87CEEB"; ctx.fillRect(0,0,VIRTUAL_WIDTH,VIRTUAL_HEIGHT);
            ctx.fillStyle = "#5d8aa8"; for(let i=0; i<6; i++) { let bx = (i * 600) - (state.cameraX * 0.15) % 600; ctx.beginPath(); ctx.moveTo(bx - 200, VIRTUAL_HEIGHT); ctx.lineTo(bx + 100, 150); ctx.lineTo(bx + 400, VIRTUAL_HEIGHT); ctx.fill(); }
            ctx.fillStyle = "#2d5a27"; for(let i=0; i<8; i++) { let bx = (i * 400) - (state.cameraX * 0.4) % 400; ctx.beginPath(); ctx.arc(bx, VIRTUAL_HEIGHT + 50, 250, 0, Math.PI * 2); ctx.fill(); }
        }

        function gameLoop() {
            if (!state.playing) return;
            state.animationFrame++; ctx.clearRect(0,0,VIRTUAL_WIDTH,VIRTUAL_HEIGHT); drawBackground();
            state.ninja.update(); state.boss.update();
            state.cameraX = Math.max(0, Math.min(state.ninja.x - 300, config.levelWidth - VIRTUAL_WIDTH));
            state.platforms.forEach(p => { ctx.fillStyle = "#386632"; ctx.fillRect(p.x - state.cameraX, p.y, p.w, p.h); ctx.fillStyle = "#5c3c1e"; ctx.fillRect(p.x - state.cameraX, p.y + 6, p.w, p.h - 6); });
            if (!state.boss.freed) { ctx.fillStyle = "#444"; ctx.fillRect(state.cage.x - state.cameraX, state.cage.y - 12, state.cage.w, 18); ctx.strokeStyle = "#222"; ctx.lineWidth = 5; for(let i=0; i<6; i++) { ctx.beginPath(); ctx.moveTo(state.cage.x + i*30 - state.cameraX, state.cage.y); ctx.lineTo(state.cage.x + i*30 - state.cameraX, state.cage.y + state.cage.h); ctx.stroke(); } ctx.fillStyle = "#222"; ctx.fillRect(state.cage.x - state.cameraX - 5, state.cage.y + state.cage.h, state.cage.w + 10, 12); }
            state.stars.forEach(s => { if(!s.collected) { ctx.font = "30px Arial"; ctx.fillText("‚≠ê", s.x - state.cameraX, s.y); } });
            state.puzzles.forEach(p => { if(!p.solved) { ctx.font = "40px Arial"; ctx.fillText(p.type === 'math' ? "üìú" : "üó°Ô∏è", p.x - state.cameraX, p.y); } });
            state.shurikens.forEach((s, i) => { s.x += s.vx; s.angle += 0.5; ctx.save(); ctx.translate(s.x - state.cameraX, s.y); ctx.rotate(s.angle); ctx.fillStyle = "#777"; ctx.fillRect(-12, -2, 24, 4); ctx.fillRect(-2, -12, 4, 24); ctx.restore(); });
            state.fireballs.forEach((f, i) => { f.x += f.vx; ctx.font = "28px Arial"; ctx.fillText("üî•", f.x - state.cameraX, f.y); });
            state.ninja.draw(); state.boss.draw();
            if (state.shurikenCooldown > 0) state.shurikenCooldown--;
            checkCollisions(); requestAnimationFrame(gameLoop);
        }

        // Event Listeners
        document.getElementById('btn-play').onclick = () => { audioCtx.resume(); state.playing = true; document.getElementById('start-screen').classList.add('hidden'); document.getElementById('ui-overlay').classList.remove('hidden'); initLevel(); gameLoop(); };
        
        // Boutons Math√©matiques
        document.querySelectorAll('.num-btn[data-val]').forEach(btn => btn.onclick = () => addDigit(btn.dataset.val));
        document.getElementById('btn-math-clear').onclick = clearDigits;
        document.getElementById('btn-math-val').onclick = validateMath;

        window.onkeydown = e => { state.keys[e.key] = true; };
        window.onkeyup = e => state.keys[e.key] = false;

        // Configuration tactile robuste
        const setupControl = (id, key) => {
            const el = document.getElementById(id);
            const start = (e) => { e.preventDefault(); state.keys[key] = true; };
            const end = (e) => { e.preventDefault(); state.keys[key] = false; };
            el.addEventListener('touchstart', start, {passive: false});
            el.addEventListener('touchend', end, {passive: false});
            el.onmousedown = () => state.keys[key] = true;
            el.onmouseup = () => state.keys[key] = false;
        };
        setupControl('btn-left', 'left'); setupControl('btn-right', 'right'); setupControl('btn-jump', 'jump'); setupControl('btn-shoot', 'shoot');
    </script>
</body>
</html>
